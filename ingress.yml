.base_job:
  variables:
    USKUBECONFIG: /home/gitlab-runner/.kube/iowa-a.kubeconfig


.combined-ingress:
  extends: .base_job
  # this is a way to ensure only one copy of this job will run at a time.
  stage: build
  resource_group: combined-ingress
  variables:
    version: 0.0.4
    image: mozmeao/combinedingress
    GIT_STRATEGY: clone
    port: 80
    branch_prefix: demo/
    service: library
    domain: example.com
  tags:
    - iowa-c
  script:
    - mkdir output
    - git fetch --all
    - docker pull $image:$version
    - docker run -v $(pwd)/output:/output -v $(pwd):/repo $image:$version $service $port $domain $branch_prefix
    - export KUBECONFIG=$USKUBECONFIG
    - echo $KUBECONFIG
    - kubectl get po
    - ls output
    - kubectl create namespace demo-shared-$service
    - kubectl apply -f output/ingress.yml
